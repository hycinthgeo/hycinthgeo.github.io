<!DOCTYPE html>
<html lang="en">
<p style="font-size:120%; color:black; font-weight: bold;"> California and Nevada: Historic vs. Recent Earthquakes9</p>

  <head>
    <meta charset="utf-8">
    <title>Mercator projection</title>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
    /*path {
      fill: #ccc;
      stroke: #fff;
      stroke-width: .5px;
    }*/
    .counties:hover {
      fill: orange;
    }
    body {
      text-align: center;
    }
		div.tooltip { 
			position: absolute;     
			text-align: center;     
			width: 80px;          
			height: 14px;         
			padding: 2px;       
			font: 12px sans-serif;    
			background: #fff; 
			border: 0px;        
			pointer-events: none;     
		}
	</style>
  </head>




<body>
    <!--<div id="option">
        <input name="faultButton" 
               type="button" 
               value="Show earthquake-active faults" 
               onclick="loadFaults()" />
    </div>-->
    <form name="myform_historic" onSubmit="return handleClick()">
        <input name="Submit"  type="submit" value="Historic: Magnitude Treshold" />
        <input type="text" id="histMag" maxlength="" />

        <input name="Submit"  type="submit" value="Start Date" />
        <input type="text" id="histStart" maxlength="" />

        <input name="Submit"  type="submit" value="End Date" />
        <input type="text" id="histEnd" maxlength="" />

    </form>

    <form name="myform_recent" onSubmit="return handleClick_recent()">
        <input name="Submit"  type="submit" value="Recent:  Magnitude Treshold" />
        <input type="text" id="recMag" maxlength="" />

        <input name="Submit"  type="submit" value="Start Date" />
        <input type="text" id="recStart" maxlength="" />

        <input name="Submit"  type="submit" value="End Date" />
        <input type="text" id="recEnd" maxlength="" />

    </form>

    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>
      function handleClick(event){
          console.log(document.getElementById("histMag").value, document.getElementById("histStart").value, document.getElementById("histEnd").value)
          //draw(document.getElementById("myRadius").value, document.getElementById("myColor").value)
          vis_historic_earthquake(document.getElementById("histMag").value, document.getElementById("histStart").value, document.getElementById("histEnd").value);
          return false;
      }
      function handleClick_recent(event){
          console.log(document.getElementById("recMag").value, document.getElementById("recStart").value, document.getElementById("recEnd").value)
          //draw(document.getElementById("myRadius").value, document.getElementById("myColor").value)
          vis_recent_earthquake(document.getElementById("recMag").value, document.getElementById("recStart").value, document.getElementById("recEnd").value);
          return false;
      }

      var width = 1000,
          height = 500;
      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height);    

      svg.append("rect").attr("x", 0).attr("y", 0).attr("width", 1000).attr("height", 5).attr("fill", "lightblue")

      var projection = d3.geo.mercator()
          .center([ -120, 38 ])
          .translate([ 170, height * 0.4 ])
          .scale([ 2000 ]);
      var generator = d3.geo.path().projection(projection);



      const LAT_MIN = 32;
      const LAT_MAX = 42;
      const LONG_MIN = -125;
      const LONG_MAX = -114;

      const text_hor_align1 = 450;
      const text_hor_align2 = 500;
      const text_box_width = 180;

      const hint_hor_align = 700;

      const vert_datum1 = 40;
      const vert_text_space = 15;

      const vert_datum2 = 140;
      const vert_datum3 = 240;

      const vert_example = 300;

      //basemap of counties and tooltip
      var tooltip = d3.select("body").append("div") 
          .attr("class", "tooltip").attr("fill", "orange")       
          .style("opacity", 0);

      
      var url_counties = "https://github.com/hycinthgeo/hycinthgeo.github.io/blob/master/data_geojson/county2017_ca.geojson"
      var local_path_ca = "data_geojson/county2017_ca.geojson"
      var local_path_nv = "data_geojson/county2017_nv.geojson"

      function vis_counties(local_path){
        d3.json(local_path, function(json) {
          svg.append("g").selectAll("path")
            .data(json.features)
            .enter()
            .append("path").attr("class", "counties")
            .attr("stroke", "gray").attr("fill", "none").attr("stroke-width", ".5px")      
            .attr("d", generator)
            .on("mouseover", function(d) {    
              tooltip.transition()    
              .duration(200)    
              .style("opacity", .5);    
              tooltip.html(d.properties.NAME)  
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");  
            }) 
            .on("mouseout", function(d) {   
              tooltip.transition()    
              .duration(500)    
              .style("opacity", 0); 
            });
        });
      };
      vis_counties(local_path_ca);
      vis_counties(local_path_nv);

      function vis_states(local_path, state_name){
        d3.json(local_path, function(json) {
          svg.append("g").selectAll("path")
            .data(json.features)
            .enter()
            .append("path").attr("class", "states")
            .attr("stroke", "gray").attr("fill", "none").attr("stroke-width", "2px")      
            .attr("d", generator)
          var text_or = svg.append("text")
          .attr("x", 30)
          .attr("dy", 15);

          text_or.append("textPath")
              .attr("stroke","black")
              .attr("xlink:href","#path_or")
              .text(state_name);

        });   

      };
      vis_states("data_geojson/states2017_ca.geojson", "California");
      vis_states("data_geojson/states2017_nv.geojson", "Nevada");

      //visualize earthquake active faults
      //function loadFaults(){


      svg.append("text")
          .attr("x", text_hor_align1)             
          .attr("y", vert_datum1)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Step 1: Base Map - View Geographic References").attr("font-size", 14).attr("font-weight", "bold");  

      //fault legends
      var lineData = [ { "x": text_hor_align2 - 13,   "y": vert_datum1 + vert_text_space * 0.3},  { "x": text_hor_align2 - 9,  "y": vert_datum1 + vert_text_space * 1.2}];
      var lineFunction = d3.svg.line()
                          .x(function(d) { return d.x; })
                          .y(function(d) { return d.y; })
                          .interpolate("linear");
      var lineGraph = svg.append("path")
                            .attr("d", lineFunction(lineData))
                            .attr("stroke", "red")
                            .attr("stroke-width", 2)
                            .attr("fill", "none");


      //show or hide faults            
      function basemap_show_or_hide_faults(){
        d3.json("data_geojson/faults_earthquake_active_v2.geojson", function(json) {
          svg.append("g").attr("id", "faults").selectAll("path")
            .data(json.features)
            .enter()
            .append("path").attr("class", "faults")
            .attr("stroke", "red")
            .attr("d", generator);

                // Add the blue line title
            var barHeight = 20;
            var bars = svg.append("g")
            .selectAll("rect").data([0]).enter().append("g")
            .attr("transform", function(d, i) { return "translate(" + text_hor_align2.toString() + ", " + (vert_datum1 + vert_text_space).toString() +")";})
            /*bars.append("rect")
            .attr("x", 0).attr("y", 0)
            .attr("width", text_box_width).attr("height", barHeight).attr("fill", "#ccc")      */
            bars.append("text")
              .attr("x", 0)             
              .attr("y", 0)//barHeight/2)    
              .attr("class", "legend")
              .style("fill", "black")         
              .text("Earthquake-active Faults (2018)").attr("font-size", 12);

           svg.append("text")
            .attr("x", hint_hor_align)             
            .attr("y", vert_datum1 + vert_text_space)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Hint: Click HERE to hide/show").attr("font-size", 12)
            .on("click", function(){
              // Determine if current line is visible
              var active   = faults.active ? false : true,
                newOpacity = active ? 0 : 1;
              // Hide or show the elements
              d3.select("#faults").style("opacity", newOpacity);
              // Update whether or not the elements are active
              faults.active = active;
            });
        });
      };
      basemap_show_or_hide_faults();
      basemap_show_or_hide_cities();


      //counties legend
      var lineData2 = [ { "x": text_hor_align2 - 13,   "y": vert_datum1 + vert_text_space * 3 - 10}, 
                        { "x": text_hor_align2 - 8,  "y": vert_datum1 + vert_text_space * 3 -8}, 
                        { "x": text_hor_align2 - 9,  "y": vert_datum1 + vert_text_space * 3 + 2},
                        { "x": text_hor_align2 - 14,  "y": vert_datum1 + vert_text_space * 3 + 3},
                        { "x": text_hor_align2 - 13,   "y": vert_datum1 + vert_text_space * 3 - 10}];
      var lineFunction2 = d3.svg.line()
                          .x(function(d) { return d.x; })
                          .y(function(d) { return d.y; })
                          .interpolate("linear");
      var lineGraph = svg.append("path")
                            .attr("d", lineFunction2(lineData2))
                            .attr("stroke", "gray")
                            .attr("stroke-width", 1)
                            .attr("fill", "none");
        var bars = svg.append("g")
        .selectAll("rect").data([0]).enter().append("g")
        .attr("transform", function(d, i) { return "translate(" + text_hor_align2.toString() + "," + (vert_datum1 + vert_text_space * 3).toString() +" )";})
        bars.append("text")
          .attr("x", 0)             
          .attr("y", 0)//barHeight/2)    
          .attr("class", "legend")
          .style("fill", "black")         
          .text("Outlines of a county").attr("font-size", 12);
       svg.append("text")
        .attr("x", hint_hor_align)             
        .attr("y", vert_datum1 + vert_text_space * 3)    
        .attr("class", "legend")
        .style("fill", "gray")
        .text("Hint: Hover on the base map for a county name").attr("font-size", 12);



      svg.append("text")
          .attr("x", text_hor_align1)             
          .attr("y", vert_datum2)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Step 2: Show Your Interested Historic Earthquakes").attr("font-size", 14).attr("font-weight", "bold");  
      svg.append("text")
        .attr("x", text_hor_align2)             
        .attr("y", vert_datum2 + vert_text_space)    
        .attr("class", "legend")
        .style("fill", "Black")
        .text("Your Selected Historic Earthquakes").attr("font-size", 12);

      svg.append("text")
            .attr("x", hint_hor_align)             
            .attr("y", vert_datum2 + vert_text_space)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Hint: Fill the above form for the 1st row, and press ENTER").attr("font-size", 12);
      svg.append("text")
            .attr("x", hint_hor_align + 20)             
            .attr("y", vert_datum2 + vert_text_space * 2)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Example: 6.0    1900-01-01    2000-01-01").attr("font-size", 12);
      svg.append("text")
            .attr("x", hint_hor_align)             
            .attr("y", vert_datum2 + vert_text_space * 3)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Hint: Hover on points for more details").attr("font-size", 12);

      svg.append("circle")
          .attr("cx", text_hor_align2 - 10).attr("cy", vert_datum2 + vert_text_space - 5)   
          .attr("r", "6px")  
          .attr("fill", "gray")



      //visualize historic earthquake 
      var tooltip_scatter = d3.select("body").append("div") 
          .attr("class", "tooltip").attr("fill", "lightblue")       
          .style("opacity", 0);


      var user_hist_mag_thre = 4.0
      var user_hist_start = "2010-07-01"
      var user_hist_end = "2011-07-01"
      //var usgs_url_historic = "https://earthquake.usgs.gov/fdsnws/event/1/query.geojson?starttime=" + "2008-07-01" +"%2000:00:00&endtime=" + "2010-07-31" + "%2023:59:59&maxlatitude=42&minlatitude=32&maxlongitude=-113&minlongitude=-125&minmagnitude=" + user_hist_mag_thre.toString() + "&orderby=time"

      function vis_historic_earthquake(user_hist_mag_thre, user_hist_start, user_hist_end){
        var usgs_url_historic = "https://earthquake.usgs.gov/fdsnws/event/1/query.geojson?starttime=" + user_hist_start + "%2000:00:00&endtime=" + user_hist_end + "%2023:59:59&maxlatitude=" + LAT_MAX.toString() + "&minlatitude=" + LAT_MIN.toString() + "&maxlongitude=" + LONG_MAX.toString() + "&minlongitude=" + LONG_MIN.toString() + "&minmagnitude=" + user_hist_mag_thre.toString() + "&orderby=time"
        //console.log(usgs_url_historic)
        //d3.json("data_geojson/usgs_query_july_m45p.geojson", function(json) {
        d3.json(usgs_url_historic, function(json) {
          svg.append("g").selectAll("rect")
            .data(json.features)
            .enter()
            .append("rect")
            .attr("cx", function (d) { return projection(d.geometry.coordinates)[0]; })
            .attr("cy", function (d) { return projection(d.geometry.coordinates)[1]; })
            .attr("r", function(d) { return d.properties.mag.toString() + "px"; })
            .attr("fill", "blue")
            .on("mouseover", function(d) {    
              tooltip_scatter.transition()    
              .duration(200)    
              .style("opacity", .5);    
              tooltip_scatter.html(d.properties.title + ", mag = " + d.properties.mag)  
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");  
            }) 
            .on("mouseout", function(d) {   
              tooltip_scatter.transition()    
              .duration(500)    
              .style("opacity", 0); 
            })
        });
      };

      //vis_historic_earthquake(user_hist_mag_thre, user_hist_start, user_hist_end);
      //add tooltip

      //add recent earthquakes 
      svg.append("text")
          .attr("x", text_hor_align1)             
          .attr("y", vert_datum3)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Step 3: Show Your Interested Recent Earthquakes").attr("font-size", 14).attr("font-weight", "bold");    
      svg.append("text")
        .attr("x", text_hor_align2)             
        .attr("y", vert_datum3 + vert_text_space)    
        .attr("class", "legend")
        .style("fill", "Black")
        .text("Your Selected Recent Earthquakes").attr("font-size", 12); 
      svg.append("text")
            .attr("x", hint_hor_align)             
            .attr("y", vert_datum3 + vert_text_space)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Hint: Fill the above form for the 2nd row, and press ENTER").attr("font-size", 12);
      svg.append("text")
            .attr("x", hint_hor_align + 20)             
            .attr("y", vert_datum3 + vert_text_space * 2)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Example: 6.0    2000-01-01    2019-08-04").attr("font-size", 12);
      svg.append("text")
            .attr("x", hint_hor_align)             
            .attr("y", vert_datum3 + vert_text_space * 3)    
            .attr("class", "legend")
            .style("fill", "gray")
            .text("Hint: Hover on points for more details").attr("font-size", 12);

      svg.append("circle")
          .attr("cx", text_hor_align2 - 10).attr("cy", vert_datum3 + vert_text_space - 5)   
          .attr("r", "6px")  
          .attr("fill", "green")

      var tooltip_recent = d3.select("body").append("div") 
          .attr("class", "tooltip").attr("fill", "lightblue")       
          .style("opacity", 0);

      var user_recent_mag_thre = 2.5
      var user_recent_start = "2019-07-01"
      var user_recent_end = "2019-07-31"

      function vis_recent_earthquake(user_recent_mag_thre, user_recent_start, user_recent_end){
        var usgs_url_recent = "https://earthquake.usgs.gov/fdsnws/event/1/query.geojson?starttime=" + user_recent_start + "%2000:00:00&endtime=" + user_recent_end + "%2023:59:59&maxlatitude=" + LAT_MAX.toString() + "&minlatitude=" + LAT_MIN.toString() + "&maxlongitude=" + LONG_MAX.toString() + "&minlongitude=" + LONG_MIN.toString() + "&minmagnitude=" + user_recent_mag_thre.toString() + "&orderby=time"
        //d3.json("data_geojson/usgs_query_july_m45p.geojson", function(json) {
        d3.json(usgs_url_recent, function(json) {
          svg.append("g").selectAll("rect")
            .data(json.features)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return projection(d.geometry.coordinates)[0]; })
            .attr("cy", function (d) { return projection(d.geometry.coordinates)[1]; })
            .attr("r", function(d) { return d.properties.mag.toString() + "px"; })
            .attr("fill", "green")
            .on("mouseover", function(d) {    
              tooltip_recent.transition()    
              .duration(200)    
              .style("opacity", .5);    
              tooltip_recent.html(d.properties.title + ", mag = " + d.properties.mag)  
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");  
            }) 
            .on("mouseout", function(d) {   
              tooltip_recent.transition()    
              .duration(500) 
              .style("opacity", 0); 
            })
        });
      };


      //show or hide cities            
      function basemap_show_or_hide_cities(){
        d3.json("data_geojson/citypopulation2018_wiki.geojson", function(json) {
            var data = json.features;
            var g1 = svg.append("g").attr("id", "cities").selectAll("rect")
              .data(data)
              .enter()
              
            g1.append("rect").attr("class", "cities")
              .attr("x", function (d) { return projection(d.geometry.coordinates)[0]; })
              .attr("y", function (d) { return projection(d.geometry.coordinates)[1]; })
              .attr("width", "8px").attr("height", "8px")
              .attr("fill", "orange");

            var annotations = svg.append("g").attr("id", "cities_annotations")
                  .selectAll('cities')
                  .data(data)
                  .enter()
                  .append('text')
                 .attr("x", function (d) { return projection(d.geometry.coordinates)[0]; })
                  .attr("y", function (d) { return projection(d.geometry.coordinates)[1]; })
                  .text(function(d) { return d.properties.place; })
                  .attr('font-size', 10).attr('font-weight', 'bold')
                  .attr('text-anchor', 'end');
            /*g1.append("text").
              .attr("x", function (d) { return projection(d.geometry.coordinates)[0]; })
              .attr("y", function (d) { return projection(d.geometry.coordinates)[1]; })
              .text(function (d) {return "TEST CITY";});*/

            var barHeight = 20;
              var bars = svg.append("g")
              .selectAll("rect").data([0]).enter().append("g")
              .attr("transform", function(d, i) { return "translate(" + text_hor_align2.toString() + "," + (vert_datum1 + vert_text_space * 2).toString() +" )";})
              /*bars.append("rect")
              .attr("x", 0).attr("y", 0)
              .attr("width", text_box_width).attr("height", barHeight).attr("fill", "#ccc")    */  
              bars.append("text")
                .attr("x", 0)             
                .attr("y", 0)//barHeight/2)    
                .attr("class", "legend")
                .style("fill", "black")         
                .text("Cities with >0.5M population (2018)").attr("font-size", 12);
             svg.append("rect")
              .attr("x", text_hor_align2 - 15).attr("y", vert_datum1 + vert_text_space * 1.5)   
              .attr("width", "8px").attr("height", "8px")  
              .attr("fill", "orange")


             svg.append("text")
              .attr("x", hint_hor_align)             
              .attr("y", vert_datum1 + vert_text_space * 2)    
              .attr("class", "legend")
              .style("fill", "gray")
              .text("Hint: Click HERE to hide/show").attr("font-size", 12)
              .on("click", function(){
                // Determine if current line is visible
                var active   = cities.active ? false : true,
                  newOpacity = active ? 0 : 1;
                // Hide or show the elements
                d3.select("#cities").style("opacity", newOpacity);
                d3.select("#cities_annotations").style("opacity", newOpacity);
                // Update whether or not the elements are active
                cities.active = active;
                cities_annotations = active;
              })


          });
        };


        svg.append("text")
          .attr("x", text_hor_align1)             
          .attr("y", vert_example + vert_text_space)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Step 4: Make Observations & Author's Story").attr("font-size", 14).attr("font-weight", "bold"); 
        
        //svg.append("rect").attr("x", text_hor_align1).attr("y", vert_example + vert_text_space * 1.2)
        //  .attr("width", 1000 - text_hor_align1).attr("height", 120).attr("fill", "lightblue") 

        var example = svg.append("g").attr("id", "myexample")
        //click to see my story 
        svg.append("rect").attr("x", text_hor_align2).attr("y", vert_example + vert_text_space * 2)
          .attr("height", "8px").attr("width", "8px").attr("fill", "lightblue")

        svg.append("text")
          .attr("x", text_hor_align2)             
          .attr("y", vert_example + vert_text_space * 2)//barHeight/2)    
          .attr("class", "legend")
          .style("fill", "black")         
          .text("Author's Example").attr("font-size", 12);

        svg.append("text")
          .attr("x", hint_hor_align)             
          .attr("y", vert_example + vert_text_space * 2)    
          .attr("class", "legend")
          .style("fill", "gray")
          .text("Hint: Click HERE to hide/show").attr("font-size", 12)
          .on("click", function(){
            // Determine if current line is visible
            var active   = myexample.active ? false : true,
              newOpacity = active ? 1 : 0;
            // Hide or show the elements
            d3.select("#myexample").style("opacity", newOpacity);
            // Update whether or not the elements are active
            myexample.active = active;
          });


        var bars = example.append("g")
        .selectAll("rect").data([0]).enter().append("g")
        .attr("transform", function(d, i) { return "translate(" + text_hor_align2.toString() + ", " + (vert_example + vert_text_space * 4).toString() +")";})
        .attr("width", width - text_hor_align2)
        .attr("height", height - vert_example - vert_text_space * 4);

          bars.append("text")
            .attr("x", 0)             
            .attr("y", vert_example + vert_text_space * 3) 
            .attr("class", "legend")
            .style("fill", "lightblue")

        example.append("text")
          .attr("x", text_hor_align2)             
          .attr("y", vert_example + vert_text_space * 3)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Historic: M6.0+, 2000-01-01 ~ 2018-12-30").attr("font-size", 12);  
        example.append("text")
          .attr("x", text_hor_align2)             
          .attr("y", vert_example + vert_text_space * 4)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Recent  : M4.5+, 2019-07-01 ~ 2018-07-31").attr("font-size", 12);  
        example.append("text")
          .attr("x", text_hor_align2)             
          .attr("y", vert_example + vert_text_space * 6)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Observations  : Large earthquakes in the past 2 decades are more along the Coast, near the famous San Anders Fault Zone\n" + "Recent July earthquakes are much more landward, along a relatively quieter zone\n").attr("font-size", 12);  
        example.append("text")
          .attr("x", text_hor_align2)             
          .attr("y", vert_example + vert_text_space * 8)    
          .attr("class", "legend")
          .style("fill", "Black")
          .text("Your turn: Enjoy your interested comparisons").attr("font-size", 12);  


      //});


    </script>
</body>

</html>