<!DOCTYPE html>
<html lang="en">
  <p> Earthquake-Active Faults (California and Nearby States) </p>
  <head>
    <meta charset="utf-8">
    <title>Mercator projection</title>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
      body {
        background-color: gray;
        margin: 1em auto;
        width: 500px;
        font: 15px sans-serif;
      }
      svg {
        background-color: white;
      }
      /*g path {
        fill: none;
        stroke: #2E9C32;
      }*/

      <!-- Styles for our vis  -->
      .axis path,
      .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
      }

      .dot {
          stroke: none;
      }
      .tooltip {
          position: absolute;
          font-size: 12px;
          width:  auto;
          height: auto;
          pointer-events: none;
          background-color: white;
      }

    </style>
  </head>
  <body>
    <script>
      //Width and height
      var w = 500;
      var h = 300;

      //Define map projections
      var mercator = d3.geo.mercator()
        .center([ -120, 38 ])
        .translate([ w * 0.5, h * 0.6 ])
        .scale([ w * 2 ]);
      
      //Define path generators
      var generator = d3.geo.path().projection(mercator);

      //Very ugly place holder for Zoom in 
      d3.select("body")
      .append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
      .call(d3.behavior.zoom().on("zoom", function () {
        svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
      }));

      var svg = d3.select("body")
        .append("svg")
        .attr("width", w)
        .attr("height", h);

      //Load in GeoJSON data
      d3.json("replace.geojson", function(json) {
        svg.append("g").selectAll("path")
          .data(json.features)
          .enter()
          .append("path").attr("stroke", "blue").attr("fill", "none")
          .attr("d", generator);
      });
          /*.on("mouseover", function(d) {    
            div.transition()    
                .duration(200)    
                .style("opacity", .9);    
            div .html(d.name + "<br/>"  + d.STATEFP)  
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");  
            })          
          .on("mouseout", function(d) {   
            div.transition()    
                .duration(500)    
                .style("opacity", 0); 
        });*/



      d3.json("states2017_or.geojson", function(json) {
        svg.append("g").selectAll("path")
          .data(json.features)
          .enter()
          .append("path").attr("stroke", "blue").attr("fill", "none")
          .attr("d", generator);
      });
      d3.json("states2017_nv.geojson", function(json) {
        svg.append("g").selectAll("path")
          .data(json.features)
          .enter()
          .append("path").attr("stroke", "blue").attr("fill", "none")
          .attr("d", generator);
      });

      d3.json("faults_earthquake_active.geojson", function(json) {
        svg.append("g").selectAll("path")
          .data(json.features)
          .enter()
          .append("path").attr("stroke", "red")
          .attr("d", generator);

      });


      //project earthquake points
      d3.csv('query.csv', function loadCallback(error, data) {
                data.forEach(function(d) { // convert strings to numbers
                    d.latitude = +d.latitude;
                    d.longitude = +d.longitude;
                });
                makeVis(data);
      });

      var makeVis = function(data) {
        // Common pattern for defining vis size and margins
        var margin = { top: 20, right: 20, bottom: 30, left: 40 },
            width  = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        // Add the visualization svg canvas to the vis-container <div>
        //append San Anders fault
        var canvas = d3.select("#vis-container").append("svg")
            .attr("width",  width  + margin.left + margin.right)
            .attr("height", height + margin.top  + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Define our scales
        var colorScale = d3.scale.category10();

        var xScale = d3.scale.linear()
            .domain([ d3.min(data, function(d) { return d.longitude; }) - 1,
                      d3.max(data, function(d) { return d.longitude; }) + 1 ])
            .range([0, width]);

        var yScale = d3.scale.linear()
            .domain([ d3.min(data, function(d) { return d.latitude; }) - 1,
                      d3.max(data, function(d) { return d.latitude; }) + 1 ])
            .range([height, 0]); // flip order because y-axis origin is upper LEFT

        // Define our axes
        var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient('bottom');

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient('left');

        // Add x-axis to the canvas
        canvas.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")") // move axis to the bottom of the canvas
            .call(xAxis)
          .append("text")
            .attr("class", "label")
            .attr("x", width) // x-offset from the xAxis, move label all the way to the right
            .attr("y", -6)    // y-offset from the xAxis, moves text UPWARD!
            .style("text-anchor", "end") // right-justify text
            .text("longitude");

        // Add y-axis to the canvas
        canvas.append("g")
            .attr("class", "y axis") // .orient('left') took care of axis positioning for us
            .call(yAxis)
          .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)") // although axis is rotated, text is not
            .attr("y", 15) // y-offset from yAxis, moves text to the RIGHT because it's rotated, and positive y is DOWN
            .style("text-anchor", "end")
            .text("latitude");

        // Add the tooltip container to the vis container
        // it's invisible and its position/contents are defined during mouseover
        var tooltip = d3.select("#vis-container").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // tooltip mouseover event handler
        var tipMouseover = function(d) {
            var color = colorScale(d.mag);
            var html  = "</b> time: </b>" + d.time + "<br/>" +
                        "</b> id:   </b>" + d.id + "<br/>" +
                        "<span style='color:" + color + ";'>" + d.mag + "</span><br/>" +
                        "<b>" + d.longitude + "</b> longitude, <b/>" + d.latitude + "</b> latitude";

            tooltip.html(html)
                .style("left", (d3.event.pageX + 15) + "px")
                .style("top", (d3.event.pageY - 28) + "px")
              .transition()
                .duration(200) // ms
                .style("opacity", .9) // started as 0!

        };
        // tooltip mouseout event handler
        var tipMouseout = function(d) {
            tooltip.transition()
                .duration(300) // ms
                .style("opacity", 0); // don't care about position!
        };

        // Add data points!
        canvas.selectAll(".dot")
          .data(data)
        .enter().append("circle")
          .attr("class", "dot")
          .attr("r", 5.5) // radius size, could map to another data dimension
          .attr("cx", function(d) { return xScale( d.longitude ); })     // x position
          .attr("cy", function(d) { return yScale( d.latitude ); })  // y position
          .style("fill", function(d) { return colorScale(d.mag); })
          .on("mouseover", tipMouseover)
          .on("mouseout", tipMouseout);
      };







    </script>
  </body>
</html>